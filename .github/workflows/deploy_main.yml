name: Build & Deploy Go App to AlmaLinux VPS (Podman) - PROD

on:
  push:
    branches:
      - main # HANYA berjalan untuk branch main (Production)

env:
  # ENV variabel publik / non-secret
  APP_MODE: prod
  TZ: Asia/Jakarta
  DEFAULT_EXTERNAL_PORT: 7777
  DEFAULT_CONTEXT_TIMEOUT: 30
  LOG_LEVEL: debug
  LOGGER: zerolog
  REDIS_TIMEOUT: 2
  MINIO_SSL: true
  RABBITMQ_PORT: 5672
  IMAGOR_PORT: 8000
  TYPESENSE_PORT: 8108

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: deploy

    steps:
      # 1ï¸âƒ£ Checkout source code
      - name: Checkout source
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ secrets.GO_VERSION || '1.24' }}

      # 3ï¸âƒ£ Debug essential secrets (non-secret vars sudah di env)
      - name: Debug Info
        run: |
          echo "ðŸ” DEBUGGING DEPLOY VARIABLES"
          echo "VPS_HOST: ${{ secrets.VPS_HOST }}"
          echo "APP_NAME: ${{ secrets.APP_NAME }}"
          echo "EXTERNAL_PORT: ${{ secrets.EXTERNAL_PORT || DEFAULT_EXTERNAL_PORT }}"
          echo "TZ: $TZ"
          echo "APP_MODE: $APP_MODE"
          echo "LOG_LEVEL: $LOG_LEVEL"
          echo "âœ… Secrets and ENV loaded"

      # 4ï¸âƒ£ Build Go binary
      - name: Build Go binary
        run: |
          echo "ðŸ—ï¸ Building Go app..."
          go mod tidy
          go build -o app cmd/main.go
          ls -lh app

      # 5ï¸âƒ£ Setup SSH key
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_25519
          chmod 600 ~/.ssh/id_25519

      # 6ï¸âƒ£ Prepare VPS (create app dir, stop/remove old container)
      - name: Prepare VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key_path: ~/.ssh/id_25519
          script: |
            echo "ðŸš€ Preparing VPS environment..."
            mkdir -p ~/app
            cd ~/app
            podman stop ${{ secrets.APP_NAME || 'api-server' }} || true
            podman rm ${{ secrets.APP_NAME || 'api-server' }} || true

      # 7ï¸âƒ£ Upload binary
      - name: Upload binary
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key_path: ~/.ssh/id_25519
          source: "./app"
          target: "~/app/app"

      # 8ï¸âƒ£ Run Podman container
      - name: Run Podman container
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key_path: ~/.ssh/id_25519
          script: |
            APP_PORT=${{ secrets.EXTERNAL_PORT || DEFAULT_EXTERNAL_PORT }}
            APP_NAME=${{ secrets.APP_NAME || 'api-server' }}

            echo "ðŸš€ Running Go app in Podman..."
            cd ~/app

            # Build Dockerfile
            cat > Dockerfile <<EOF
            FROM golang:1.24
            WORKDIR /app
            COPY app .
            ENV TZ=$TZ
            EXPOSE \${APP_PORT}
            CMD ["./app"]
            EOF

            podman build -t ${APP_NAME}:latest .

            # Run container with secret + non-secret env variables
            podman run -d --name ${APP_NAME} \
              -p ${APP_PORT}:${APP_PORT} \
              --network e-klinik \
              --env APP_MODE=$APP_MODE \
              --env EXTERNAL_PORT=${APP_PORT} \
              --env CONTEXT_TIMEOUT=${{ secrets.CONTEXT_TIMEOUT || DEFAULT_CONTEXT_TIMEOUT }} \
              --env JWT_ACCESS_TOKEN_EXPIRY_HOUR=${{ secrets.JWT_ACCESS_TOKEN_EXPIRY_HOUR || 5 }} \
              --env JWT_REFRESH_TOKEN_EXPIRY_HOUR=${{ secrets.JWT_REFRESH_TOKEN_EXPIRY_HOUR || 168 }} \
              --env JWT_SECRET=${{ secrets.JWT_SECRET }} \
              --env PG_USERNAME=${{ secrets.PG_USERNAME }} \
              --env PG_PASSWORD=${{ secrets.PG_PASSWORD }} \
              --env PG_POOLMAX=${{ secrets.PG_POOLMAX || 10 }} \
              --env PG_PORT=${{ secrets.PG_PORT || 5435 }} \
              --env PG_HOST=${{ secrets.PG_HOST }} \
              --env PG_NAME=${{ secrets.PG_NAME }} \
              --env PG_SSL=${{ secrets.PG_SSL || false }} \
              --env PG_MIGRATION_URL=${{ secrets.PG_MIGRATION_URL }} \
              --env MINIO_ENDPOINT=${{ secrets.MINIO_ENDPOINT }} \
              --env MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }} \
              --env MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }} \
              --env MINIO_BUCKET1=${{ secrets.MINIO_BUCKET1 }} \
              --env MINIO_BUCKET2=${{ secrets.MINIO_BUCKET2 }} \
              --env MINIO_REGION=${{ secrets.MINIO_REGION }} \
              --env MINIO_SSL=$MINIO_SSL \
              --env LOG_LEVEL=$LOG_LEVEL \
              --env LOGGER=$LOGGER \
              --env REDIS_HOST=${{ secrets.REDIS_HOST }} \
              --env REDIS_PORT=${{ secrets.REDIS_PORT || 6380 }} \
              --env REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }} \
              --env REDIS_TIMEOUT=$REDIS_TIMEOUT \
              --env RABBITMQ_USER=${{ secrets.RABBITMQ_USER }} \
              --env RABBITMQ_PASSWORD=${{ secrets.RABBITMQ_PASSWORD }} \
              --env RABBITMQ_HOST=${{ secrets.RABBITMQ_HOST }} \
              --env RABBITMQ_PORT=$RABBITMQ_PORT \
              --env IMAGOR_HOST=${{ secrets.IMAGOR_HOST }} \
              --env IMAGOR_PORT=$IMAGOR_PORT \
              --env TYPESENSE_HOST=${{ secrets.TYPESENSE_HOST }} \
              --env TYPESENSE_PORT=$TYPESENSE_PORT \
              --env TYPESENSE_API_KEY=${{ secrets.TYPESENSE_API_KEY }} \
              --env MEILI_IMAGE_HOST=${{ secrets.MEILI_IMAGE_HOST }} \
              ${APP_NAME}:latest

            echo "âœ… App is running on port ${APP_PORT}"
